#!/bin/sh
# provide zstd src
#(
#	cd /tmp/ccache-master/build
#	sh /etc/action/store gitcheckout zstd patch
#	ln -fs zstd zstd-1.5.2
#	ln -fs zstd zstd-1.5.3
#	ln -fs zstd zstd-1.5.4
#
#)
unset DISPATCH
export XXH_INLINE_ALL=1
case $TARCH_L1 in
amd64)
	case $TARCH_L3 in
	x86-64-v3) export XXH_VECTOR=XXH_AVX2 ;;
	x86-64-v2) export XXH_VECTOR=XXH_AVX ;;
	*) export XXH_VECTOR=XXH_SSE2 ;;
	esac
	;;
arm*) export XXH_VECTOR=NEON ;;
esac
export CFLAGS="$CFLAGS -DXXH_VECTOR=$XXH_VECTOR -DXXH_STATIC_LINKING_ONLY"
export CXXFLAGS=$CFLAGS
export CPPFLAGS=$CFLAGS
cmake --log-level="STATUS" \
	-G Ninja \
	-DCMAKE_BUILD_TYPE=Release \
	-DCPACK_STRIP_FILES=ON \
	-DCMAKE_INSTALL_PREFIX=$PREFIX \
	-DCMAKE_SYSROOT=/usr/sysroots/$TOS.bsrv.$TARCH_L1.$TARCH_L2.$TARCH_L3 \
	-DCMAKE_LIBRARY_PATH=$SRM/usr/lib/ \
	-DCMAKE_INCLUDE_PATH=$SRM/usr/include \
	-DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER \
	-DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \
	-DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY \
	-DCMAKE_FIND_ROOT_PATH_MODE_PACKAGE=ONLY \
	-DCMAKE_BUILD_TESTING=OFF \
	-DENABLE_DEBUG=OFF \
	-DENABLE_DEBUG_ALL=OFF \
	-DENABLE_DOC=OFF \
	-DENABLE_DOCUMENTATION=OFF \
	-DENABLE_MANPAGES=OFF \
	-DENABLE_TESTING=OFF \
	-DENABLE_TRACING=OFF \
	-DREDIS_STORAGE_BACKEND=OFF \
	-DENABLE_DOCUMENTATION=OFF \
	-DENABLE_TESTING=OFF \
	-DSTATIC_LINK=ON \
	-DENABLE_IPO=ON \
	-DZSTD_FROM_INTERNET=OFF \
	..
